name: "Package Publishing and Release Automation PRP"
description: |

## Purpose

Enable automated versioning, changelog generation, and publishing workflow for the MDXEditor plugins monorepo using Changesets and GitHub Actions.

## Core Principles

1. **Context is King**: Include ALL necessary documentation, examples, and caveats
2. **Validation Loops**: Provide executable tests/lints the AI can run and fix
3. **Information Dense**: Use keywords and patterns from the codebase
4. **Progressive Success**: Start simple, validate, then enhance
5. **Global rules**: Follow all rules in CLAUDE.md

---

## Goal

Set up a complete package publishing pipeline that:

- Manages versioning and changelogs using Changesets
- Automates releases through GitHub Actions
- Ensures only properly configured packages are published
- Maintains up-to-date documentation

## Why

- **Developer efficiency**: Automate the tedious process of version management and publishing
- **Consistency**: Standardize how versions are bumped and changelogs are generated
- **Quality assurance**: Ensure packages pass all quality checks before publishing
- **Transparency**: Auto-generate changelogs that document what changed in each release
- **CI/CD best practices**: Leverage GitHub Actions for reliable, repeatable releases

## What

Implement a complete release workflow that:

1. Verifies package.json configurations are correct for npm publishing
2. Updates README files with proper installation and usage instructions
3. Installs and configures Changesets for version/changelog management
4. Creates GitHub Actions workflows for automated publishing
5. Ensures workflows build, test, and validate packages before publishing

### Success Criteria

- [ ] Package.json files have correct configurations for npm publishing (exports, types, files, etc.)
- [ ] README files document installation and basic usage for published packages
- [ ] Changesets is installed and configured with appropriate settings
- [ ] GitHub Actions workflow successfully publishes packages on release
- [ ] Workflow runs build, type-check, lint, and format checks before publishing
- [ ] Workflow automatically publishes packages when "Version Packages" PR is merged
- [ ] Workflow fails immediately if any package publish fails (no partial publishes)
- [ ] Published packages are installable via `pnpm add @mdxeditor/package-name`
- [ ] Git tags are created for each published version

## Clarifications

### Session 2025-11-16

- Q: How should packages be published when the 'Version Packages' PR is merged? → A: Fully automatic
- Q: Which type of NPM token should be created for GitHub Actions? → A: Granular Access
- Q: What should happen if package publishing fails mid-process (some succeed, some fail)? → A: Fail workflow

## All Needed Context

### Documentation & References

```yaml
# MUST READ - Include these in your context window
- url: https://github.com/changesets/changesets
  why: Core changesets documentation and concepts

- url: https://github.com/changesets/action
  why: GitHub Actions integration for automated releases

- url: https://pnpm.io/using-changesets
  why: Specific guidance for using changesets with pnpm workspaces

- file: packages/source-preview-plugin/package.json
  why: Current package configuration - verify publishing fields

- file: packages/tooling/package.json
  why: Private package - should NOT be published

- file: lefthook.yml
  why: Existing pre-commit/pre-push hooks that validate code quality

- file: CLAUDE.md
  why: Project conventions and commands to follow
```

### Current Codebase Tree

```
.
├── CLAUDE.md
├── lefthook.yml
├── LICENSE
├── package.json (root - private)
├── packages
│   ├── source-preview-plugin (PUBLISHABLE)
│   │   ├── dist/
│   │   ├── package.json (v0.0.1)
│   │   ├── README.md (minimal)
│   │   ├── src/
│   │   ├── vite.config.ts
│   │   └── tsconfig.json
│   └── tooling (PRIVATE - not published)
│       ├── package.json (private: true)
│       ├── eslint.config.mjs
│       ├── prettier.config.mjs
│       ├── tsconfig.base.json
│       └── vite.config.base.ts
├── pnpm-lock.yaml
├── pnpm-workspace.yaml
└── specs/
```

### Desired Codebase Tree

```
.
├── .changeset/
│   ├── config.json (NEW - changesets configuration)
│   └── README.md (NEW - how to create changesets)
├── .github/
│   └── workflows/
│       └── release.yml (NEW - automated publishing workflow)
├── packages/
│   ├── source-preview-plugin/
│   │   ├── package.json (VERIFY - publishing fields correct)
│   │   ├── README.md (UPDATE - installation and usage)
│   │   └── CHANGELOG.md (AUTO-GENERATED by changesets)
│   └── tooling/
│       └── package.json (VERIFY - private: true set)
├── package.json (UPDATE - add changeset scripts)
└── (all other existing files)
```

### Known Gotchas & Library Quirks

```bash
# CRITICAL: Changesets requires 'access' field in config for scoped packages
# Scoped packages like @mdxeditor/* default to restricted access
# Must set "access": "public" in .changeset/config.json

# CRITICAL: pnpm requires specific commands for publishing
# Use 'pnpm changeset publish' NOT 'npm publish'
# Changesets handles running the correct package manager

# CRITICAL: GitHub Actions requires NPM_TOKEN secret
# Must create GRANULAR ACCESS token at https://www.npmjs.com/settings/tokens
# Token type: "Granular Access Token" (not Classic)
# Permissions: Packages and scopes -> Read and Write for @mdxeditor scope
# Expiration: Set appropriate expiration (90 days recommended)
# Add as secret in GitHub repo settings: Settings -> Secrets -> Actions -> New repository secret

# CRITICAL: GitHub Actions needs write permissions
# Settings -> Actions -> General -> Workflow permissions
# Set to "Read and write permissions" to allow PR creation

# CRITICAL: Private packages should NOT be published
# Verify packages/tooling has "private": true in package.json
# Changesets will skip private packages by default

# CRITICAL: Package must be built before publishing
# Ensure 'dist' directory exists and is up to date
# Add 'build' script to package.json if missing

# CRITICAL: Lefthook already validates code quality
# Pre-commit: type-check, lint, format-check
# Pre-push: build
# GitHub Actions workflow should run same validations

# CRITICAL: Version packages before publishing
# Workflow sequence: changeset version -> git commit -> changeset publish
# The action handles this automatically via version and publish inputs

# CRITICAL: Workflow publishes automatically on PR merge
# When "Version Packages" PR is merged to main, packages are published immediately
# Ensure all quality checks pass before merging the version PR
# No manual approval step - merge = publish

# CRITICAL: Workflow fails fast on publish errors
# If any package fails to publish, the entire workflow fails immediately
# This prevents partial publishes and keeps package versions in sync
# Check workflow logs for specific error messages
# May need to manually fix issues and re-run workflow
```

### Package.json Fields Required for Publishing

```json
{
  "name": "@mdxeditor/package-name",
  "version": "0.0.1",
  "type": "module",
  "license": "MIT",
  "main": "./dist/index.js",
  "types": "./dist/index.d.ts",
  "exports": {
    ".": {
      "types": "./dist/index.d.ts",
      "default": "./dist/index.js"
    }
  },
  "files": ["dist"],
  "scripts": {
    "build": "vite build"
  }
}
```

## Implementation Blueprint

### Data Models and Structure

No new data models required. Configuration files only.

### List of Tasks

```yaml
Task 1: Verify and update package.json files for publishing
  MODIFY packages/source-preview-plugin/package.json:
    - Verify all publishing fields are present and correct
    - Ensure 'files' field includes only 'dist' directory
    - Confirm 'main', 'types', and 'exports' point to dist output
  VERIFY packages/tooling/package.json:
    - Ensure 'private: true' is set (should NOT publish)
  PATTERN: See "Package.json Fields Required for Publishing" section above

Task 2: Update README files
  MODIFY packages/source-preview-plugin/README.md:
    - Add comprehensive installation instructions
    - Add basic usage example
    - Document peer dependencies
    - Add links to documentation (if available)
  SKIP packages/tooling/README.md:
    - Tooling is private, README not required for npm
  PATTERN: Standard npm package README structure

Task 3: Install and configure Changesets
  CREATE .changeset/config.json:
    - Set up changesets configuration
    - Configure 'access: public' for scoped packages
    - Set changelog format
    - Configure commit message format
  CREATE .changeset/README.md:
    - Explain how to create changesets
    - Document workflow for contributors
  MODIFY package.json (root):
    - Add changeset scripts to root package.json
  PATTERN: Use official changesets configuration from documentation

Task 4: Create GitHub Actions workflow
  CREATE .github/workflows/release.yml:
    - Trigger on push to main branch
    - Checkout code with full history
    - Setup Node.js and pnpm
    - Install dependencies
    - Run build script
    - Run validation scripts (type-check, lint, format:check)
    - Use changesets/action@v1 for version and publish
    - Configure environment variables (GITHUB_TOKEN, NPM_TOKEN)
  PATTERN: Follow official changesets/action examples

Task 5: Test the release workflow
  MANUAL:
    - Install changesets CLI locally
    - Create a test changeset
    - Run version and publish commands locally (dry-run)
    - Verify package.json versions update correctly
    - Verify CHANGELOG.md is generated
  VALIDATE:
    - Ensure no errors during changeset version
    - Verify only publishable packages are included
```

### Per Task Pseudocode

````typescript
// Task 1: Verify package.json files
// READ packages/source-preview-plugin/package.json
// VERIFY required fields exist:
//   - name (scoped: @mdxeditor/*)
//   - version
//   - type: "module"
//   - license
//   - main: "./dist/index.js"
//   - types: "./dist/index.d.ts"
//   - exports with proper structure
//   - files: ["dist"]
// UPDATE if any fields missing or incorrect

// READ packages/tooling/package.json
// VERIFY private: true is set
// WARN if not set (should NOT publish this)

// Task 2: Update README
// READ packages/source-preview-plugin/README.md
// PATTERN: Standard npm README structure
// SECTIONS:
//   # Package Name
//   Description
//   ## Installation
//   ```bash
//   pnpm add @mdxeditor/source-preview-plugin
//   # or
//   npm install @mdxeditor/source-preview-plugin
//   ```
//   ## Usage
//   Basic code example showing how to use the plugin
//   ## Peer Dependencies
//   List React and other peer deps with versions
//   ## License
//   MIT

// Task 3: Install and configure changesets
// RUN: pnpm add -Dw @changesets/cli
// RUN: pnpm changeset init
// This creates .changeset directory with config.json

// MODIFY .changeset/config.json
{
  "$schema": "https://unpkg.com/@changesets/config@3.0.0/schema.json",
  "changelog": "@changesets/cli/changelog",
  "commit": false,
  "fixed": [],
  "linked": [],
  "access": "public",  // CRITICAL: Required for scoped packages
  "baseBranch": "main",
  "updateInternalDependencies": "patch",
  "ignore": []
}

// MODIFY package.json (root)
// ADD scripts:
{
  "scripts": {
    "changeset": "changeset",
    "version-packages": "changeset version",
    "release": "pnpm build && changeset publish"
  }
}

// Task 4: Create GitHub workflow
// CREATE .github/workflows/release.yml
name: Release

on:
  push:
    branches:
      - main

concurrency: ${{ github.workflow }}-${{ github.ref }}

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages
        run: pnpm build

      - name: Run type checking
        run: pnpm type-check

      - name: Run linting
        run: pnpm lint

      - name: Run format check
        run: pnpm format:check

      - name: Create Release Pull Request or Publish
        id: changesets
        uses: changesets/action@v1
        with:
          version: pnpm version-packages
          publish: pnpm release
          commit: "chore: version packages"
          title: "chore: version packages"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

// Task 5: Test locally
// RUN: pnpm changeset
// Follow prompts to create a changeset
// SELECT packages to bump
// SELECT bump type (major/minor/patch)
// WRITE summary of changes

// RUN: pnpm version-packages
// VERIFY package.json versions updated
// VERIFY CHANGELOG.md created/updated

// DRY RUN publish (don't actually publish):
// RUN: pnpm build
// VERIFY dist directory created
// CHECK dist contents match 'files' in package.json
````

### Integration Points

```yaml
NPM_REGISTRY:
  - authentication: Requires NPM_TOKEN secret in GitHub
  - access: Must be set to "public" for scoped packages
  - registry: Default registry.npmjs.org

GITHUB_SECRETS:
  - NPM_TOKEN: Create at https://www.npmjs.com/settings/tokens
    - Type: "Granular Access Token" (modern, more secure)
    - Scope: Packages and scopes -> Select @mdxeditor organization/scope
    - Permissions: Read and Write access for packages
    - Expiration: Set to 90 days or appropriate duration
    - Add to: Repository Settings -> Secrets and variables -> Actions -> New repository secret
  - GITHUB_TOKEN: Automatically provided by GitHub Actions
    - Permissions: Requires "Read and write" in repo settings

PNPM_WORKSPACE:
  - config: pnpm-workspace.yaml defines packages
  - commands: Use 'pnpm -r' for recursive operations
  - changesets: Automatically detects workspace packages

EXISTING_VALIDATION:
  - lefthook: Pre-commit and pre-push hooks validate quality
  - workflow: GitHub Actions should run same validations
  - consistency: Ensures published code meets quality standards
```

## Validation Loop

### Level 1: Configuration Validation

```bash
# Verify changesets is installed
pnpm list @changesets/cli

# Verify configuration file exists
cat .changeset/config.json

# Verify package.json scripts exist
grep -A 3 '"changeset"' package.json
```

### Level 2: Local Changesets Workflow

```bash
# Create a test changeset
pnpm changeset

# Version packages (updates package.json and CHANGELOG.md)
pnpm version-packages

# Verify changes
git status
git diff

# Build packages
pnpm build

# Verify dist output
ls -la packages/source-preview-plugin/dist/

# Run all quality checks
pnpm type-check
pnpm lint
pnpm format:check
```

### Level 3: GitHub Workflow Validation

```bash
# Validate workflow syntax
cat .github/workflows/release.yml

# Push changes to trigger workflow
git add .
git commit -m "test: configure release workflow"
git push origin main

# Check workflow run in GitHub Actions UI
# Verify:
# - Workflow triggers on push to main
# - All steps complete successfully
# - Release PR is created if changesets exist
```

### Level 4: Publishing Test (Manual Verification)

```bash
# After workflow creates release PR:
# 1. Review the PR
# 2. Verify version bumps are correct
# 3. Verify CHANGELOG.md updates
# 4. Merge the PR
# 5. Workflow should auto-publish packages
# 6. Verify package appears on npm:
#    https://www.npmjs.com/package/@mdxeditor/source-preview-plugin
# 7. Test installation:
pnpm add @mdxeditor/source-preview-plugin
```

## Final Validation Checklist

- [ ] @changesets/cli installed as dev dependency
- [ ] .changeset/config.json created with correct settings
- [ ] .changeset/config.json has "access": "public"
- [ ] Root package.json has changeset scripts
- [ ] .github/workflows/release.yml created
- [ ] Workflow triggers on push to main
- [ ] Workflow runs build and all quality checks
- [ ] Workflow uses changesets/action@v1
- [ ] NPM_TOKEN secret configured in GitHub repo settings
- [ ] GitHub Actions has "Read and write" permissions
- [ ] packages/source-preview-plugin/package.json has correct publishing fields
- [ ] packages/tooling/package.json has "private": true
- [ ] packages/source-preview-plugin/README.md is comprehensive
- [ ] Can create changesets with 'pnpm changeset'
- [ ] Can version packages with 'pnpm version-packages'
- [ ] CHANGELOG.md is auto-generated
- [ ] Workflow creates release PR when changesets exist
- [ ] Workflow publishes packages when PR is merged
- [ ] Published package is installable via pnpm/npm

---

## Anti-Patterns to Avoid

- ❌ Don't publish packages/tooling (it's private shared configuration)
- ❌ Don't forget "access": "public" for scoped packages (will fail with 402)
- ❌ Don't skip quality checks before publishing
- ❌ Don't create releases without changesets (workflow won't trigger)
- ❌ Don't use npm commands directly (use pnpm for consistency)
- ❌ Don't forget to build packages before publishing
- ❌ Don't commit changesets files to main directly (should be in dedicated branch)
- ❌ Don't skip testing the workflow with a dry-run first
- ❌ Don't use personal NPM tokens (use automation tokens)
- ❌ Don't hardcode versions (let changesets manage them)

## Notes for Implementer

**Pre-requisites before GitHub workflow will work:**

1. Create NPM Granular Access Token at <https://www.npmjs.com/settings/tokens>
   - Select "Granular Access Token" (not Classic Automation token)
   - Set scope to @mdxeditor packages
   - Grant Read and Write permissions
   - Set appropriate expiration (e.g., 90 days)
2. Add NPM_TOKEN secret to GitHub repository (Settings -> Secrets -> Actions)
3. Enable "Read and write" permissions for GitHub Actions (Settings -> Actions -> General)
4. Have at least one changeset before expecting publishes
5. Understand that merging "Version Packages" PR will immediately publish to npm

**Development workflow after setup:**

1. Make changes to packages
2. Run `pnpm changeset` to document changes
3. Commit changeset file
4. Push to feature branch
5. Create PR to main
6. When PR is merged, workflow creates "Version Packages" PR
7. **CRITICAL**: Review "Version Packages" PR carefully - merging = immediate publish
8. Merge "Version Packages" PR to automatically publish packages to npm
9. Monitor workflow to ensure publish succeeds (workflow will fail if any package fails)

**Testing strategy:**

- Test locally first with `pnpm version-packages` (don't publish)
- Use `pnpm publish --dry-run` to verify what would be published
- Monitor first real workflow run closely
- Have a rollback plan (can unpublish within 72 hours)
